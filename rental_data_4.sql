use role ROL_JT;
use database EDW;
use warehouse VWH_JT;

-- ************************** SqlDBM: Snowflake *************************
-- * Generated by SqlDBM: Snowflake SampleDb, v3 by uli.bethke@sonra.io *
-- CREATE SCHEMA IF NOT EXISTS STAGING;
-- CREATE SCHEMA IF NOT EXISTS DATA_MARTS;

-- ************************************************************************************************
-- ************************************** SCHEMA INTEGRATION **************************************
-- ************************************************************************************************

use schema INTEGRATION;

--  INTEGRATION.RENTAL_VEHICLE
CREATE TABLE IF NOT EXISTS integration.rental_vehicle
(
 vin varchar NOT NULL,
 vehicle_name varchar NOT NULL,
 vehicle_type varchar NOT NULL,
 modified_date_time timestamp_ntz NOT NULL, 
 CONSTRAINT PK_rental_vehicle PRIMARY KEY (vin)
);


-- INTEGRATION.RENTAL
use schema INTEGRATION;
CREATE TABLE IF NOT EXISTS integration.rental
(
 pick_up_date_time timestamp NOT NULL,
 vin varchar NOT NULL,
 open_rental_ind varchar NOT NULL,
 drop_off_date_time timestamp NOT NULL,
 penalty_rental_charge number NOT NULL,
 actual_rental_charge number NOT NULL,
 modified_date_time timestamp NOT NULL,
 CONSTRAINT PK_rental PRIMARY KEY ( vin, pick_up_date_time ),
 CONSTRAINT FK_rental FOREIGN KEY ( vin ) REFERENCES rental_vehicle ( vin )
);

-- INTEGRATION.FUEL_LEVEL
CREATE TABLE IF NOT EXISTS integration.fuel_level
(
 fuel_level_date_time timestamp NOT NULL,
 vin varchar NOT NULL,
 fuel_level number NOT NULL,
 modified_date_time timestamp NOT NULL,
 CONSTRAINT PK_fuel_level PRIMARY KEY (vin, fuel_level_date_time),
 CONSTRAINT FK_rental FOREIGN KEY (vin) REFERENCES rental_vehicle ( vin )
);


-- ******************************************************************************************************
-- ************************************** SCHEMA STAGING ************************************************
-- ******************************************************************************************************
use schema STAGING;

-- STAGING.CAR
CREATE TABLE IF NOT EXISTS staging.car
(
 vin                varchar NOT NULL,
 vehicle_name       varchar NOT NULL,
 modified_date_time timestamp NOT NULL,
 CONSTRAINT PK_car PRIMARY KEY (vin)
);

-- STAGING.VAN
CREATE TABLE IF NOT EXISTS staging.van
(
 vin                varchar NOT NULL,
 vehicle_name       varchar NOT NULL,
 modified_date_time timestamp NOT NULL,
 CONSTRAINT PK_van PRIMARY KEY (vin)
);

-- STAGING.RENTAL
CREATE TABLE IF NOT EXISTS staging.rental
(
 pick_up_date_time timestamp NOT NULL,
 vin varchar NOT NULL,
 open_rental_ind varchar NOT NULL,
 drop_off_date_time datetime,
 penalty_rental_charge number NOT NULL,
 actual_rental_charge number NOT NULL,
 modified_date_time timestamp NOT NULL,
 CONSTRAINT PK_rental PRIMARY KEY (vin, pick_up_date_time)
);

-- STAGING.FUEL_LEVEL
use schema STAGING;
CREATE TABLE IF NOT EXISTS staging.fuel_level
(
 fuel_level_date_time timestamp NOT NULL,
 vin varchar NOT NULL,
 fuel_level number NOT NULL,
 modified_date_time timestamp NOT NULL,
 CONSTRAINT PK_fuel_level PRIMARY KEY (vin, fuel_level_date_time)
);




-- *********************************************************************************************** 
-- ************************************** SCHEMA DATA MARTS ************************************** 
-- *********************************************************************************************** 
use schema DATA_MARTS;

-- DATA_MARTS.D_VEHICLE
CREATE TABLE IF NOT EXISTS data_marts.d_vehicle
(
 vin                varchar NOT NULL,
 vehicle_name       varchar NOT NULL,
 vehicle_type       varchar NOT NULL,
 modified_date_time timestamp NOT NULL,
 CONSTRAINT PK_vehicle PRIMARY KEY (vin)
);


INSERT INTO data_marts.d_vehicle SELECT * from integration.rental_vehicle;


-- DATA_MARTS.F_RENTAL
CREATE TABLE IF NOT EXISTS data_marts.f_rental
(
 vin                   varchar NOT NULL,
 pick_up_date_time     timestamp NOT NULL,
 open_rental_ind       varchar(1) NOT NULL,
 drop_off_date_time    timestamp NOT NULL,
 drop_off_fuel_level   number,
 total_rental_charge   number,
 actual_rental_charge  number,
 penalty_rental_charge number,
 modified_date_time   timestamp NOT NULL,
 CONSTRAINT PK_f_rental PRIMARY KEY (vin, pick_up_date_time),
 CONSTRAINT FK_vin FOREIGN KEY (vin) REFERENCES data_marts.d_vehicle (vin)
);

/*
INSERT INTO data_marts.f_rental (vin, pick_up_date_time, open_rental_ind, drop_off_date_time, total_rental_charge, actual_rental_charge, penalty_rental_charge, modified_date_time) 
            SELECT vin, pick_up_date_time, open_rental_ind, drop_off_date_time, actual_rental_charge + penalty_rental_charge as total_rental_charge,actual_rental_charge, penalty_rental_charge, 
            CURRENT_TIMESTAMP from integration.rental;
    
*/

INSERT INTO data_marts.f_rental (vin, pick_up_date_time, open_rental_ind, drop_off_date_time, drop_off_fuel_level, total_rental_charge, actual_rental_charge, penalty_rental_charge, modified_date_time) 
SELECT t1.vin, t1.pick_up_date_time, t1.open_rental_ind, t1.drop_off_date_time, t2.fuel_level, t1.actual_rental_charge + t1.penalty_rental_charge as total_rental_charge, t1.actual_rental_charge, 
    t1.penalty_rental_charge, t1.modified_date_time FROM integration.rental t1
    JOIN integration.fuel_level t2 ON t1.drop_off_date_time = t2.fuel_level_date_time;

-- DATA_MARTS.F_RENTAL_AGG
CREATE TABLE IF NOT EXISTS data_marts.f_rental_agg
(
 vin                 varchar NOT NULL,
 total_rental_charge number NOT NULL, --  SUM(total_rental_charge) group by vi
 modified_date_time  timestamp NOT NULL,
 CONSTRAINT PK_rental_agg PRIMARY KEY (vin),
 CONSTRAINT FK_vin FOREIGN KEY (vin) REFERENCES data_marts.d_vehicle (vin)
);

-- ************************************** INSERT TABLE data_marts.f_rental_agg
INSERT INTO data_marts.f_rental_agg( vin, total_rental_charge, modified_date_time ) SELECT vin, SUM(total_rental_charge), current_timestamp from data_marts.f_rental group by vin;


-- DROP TABLES
/*
DROP TABLE IF EXISTS integration.rental_vehicle;
DROP TABLE IF EXISTS integration.rental;
DROP TABLE IF EXISTS integration.fuel_level;

DROP TABLE IF EXISTS staging.van;
DROP TABLE IF EXISTS staging.rental;
DROP TABLE IF EXISTS staging.fuel_level;
DROP TABLE IF EXISTS staging.car;

DROP TABLE IF EXISTS DATA_MARTS.D_VEHICLE;
DROP TABLE IF EXISTS DATA_MARTS.F_RENTAL;
DROP TABLE IF EXISTS DATA_MARTS.F_RENTAL_AGG;


-- INSERT INTEGRATION TABLES



INSERT INTO integration.rental (pick_up_date_time, vin, open_rental_ind, drop_off_date_time, penalty_rental_charge, actual_rental_charge, modified_date_time) 
VALUES ('2017-01-01 10:00:00','1HGBH41JXMN109186', 'Y', '2017-01-10 00:00:00', '100', '400', '2017-01-01 00:00:00');
INSERT INTO integration.rental (pick_up_date_time, vin, open_rental_ind, drop_off_date_time, penalty_rental_charge, actual_rental_charge, modified_date_time) 
VALUES ('2017-02-08 10:00:00','1HGBH41JXMN109186', 'Y', '2017-02-10 00:00:00', '200', '400', '2017-01-01 00:00:00');
INSERT INTO integration.rental (pick_up_date_time, vin, open_rental_ind, drop_off_date_time, penalty_rental_charge, actual_rental_charge, modified_date_time) 
VALUES ('2017-03-01 10:00:00','1HGBH41JXMN109186', 'N','2017-03-10 10:00:00','300', '400', '2017-01-01 00:00:00');

INSERT INTO integration.rental (pick_up_date_time, vin, open_rental_ind, drop_off_date_time, penalty_rental_charge, actual_rental_charge, modified_date_time) 
VALUES ('2017-01-01 10:00:00','1FAGB45ARHA387092', 'Y', '2017-01-10 00:00:00', '200', '600','2017-01-01 00:00:00');
INSERT INTO integration.rental (pick_up_date_time, vin, open_rental_ind, drop_off_date_time, penalty_rental_charge, actual_rental_charge, modified_date_time) 
VALUES ('2017-02-01 10:00:00','1FAGB45ARHA387092', 'N','2017-02-10 10:00:00', '100', '600', '2017-01-01 00:00:00');
INSERT INTO integration.rental (pick_up_date_time, vin, open_rental_ind, drop_off_date_time, penalty_rental_charge, actual_rental_charge, modified_date_time) 
VALUES ('2017-03-01 10:00:00','1FAGB45ARHA387092', 'Y', '2017-03-10 00:00:00', '400', '600', '2017-01-01 00:00:00');

INSERT INTO integration.rental (pick_up_date_time, vin, open_rental_ind, drop_off_date_time, penalty_rental_charge, actual_rental_charge, modified_date_time) 
VALUES ('2017-01-01 10:00:00','5HXXH23HXAM239085', 'Y', '2017-01-09 00:00:00', '200', '400', '2017-01-01 00:00:00');
INSERT INTO integration.rental (pick_up_date_time, vin, open_rental_ind, drop_off_date_time, penalty_rental_charge, actual_rental_charge, modified_date_time) 
VALUES ('2017-02-01 10:00:00','5HXXH23HXAM239085', 'N','2017-02-28 10:00:00', '400', '400','2017-01-01 00:00:00');
INSERT INTO integration.rental (pick_up_date_time, vin, open_rental_ind, drop_off_date_time, penalty_rental_charge, actual_rental_charge, modified_date_time) 
VALUES ('2017-03-01 10:00:00','5HXXH23HXAM239085', 'Y', '2017-03-11 00:00:00', '400', '400', '2017-01-01 00:00:00');
INSERT INTO integration.rental (pick_up_date_time, vin, open_rental_ind, drop_off_date_time, penalty_rental_charge, actual_rental_charge, modified_date_time) 
VALUES ('2017-04-01 10:00:00','5HXXH23HXAM239085', 'Y', '2017-04-21 00:00:00', '500', '400', '2017-01-01 00:00:00');

-- INSERT TABLE integration.fuel_level YYYY-MM-DD

INSERT INTO integration.fuel_level (fuel_level_date_time, vin, fuel_level, modified_date_time) VALUES ('2017-01-01 00:00:00','1FAGB45ARHA387092','1', '2017-01-01 00:00:00');
INSERT INTO integration.fuel_level (fuel_level_date_time, vin, fuel_level, modified_date_time) VALUES ('2017-01-10 00:00:00','1FAGB45ARHA387092','0.9', '2017-01-01 00:00:00');
INSERT INTO integration.fuel_level (fuel_level_date_time, vin, fuel_level, modified_date_time) VALUES ('2017-02-08 00:00:00','1FAGB45ARHA387092','0.8', '2017-01-01 00:00:00');
INSERT INTO integration.fuel_level (fuel_level_date_time, vin, fuel_level, modified_date_time) VALUES ('2017-02-10 00:00:00','1FAGB45ARHA387092','0.7', '2017-01-01 00:00:00');
INSERT INTO integration.fuel_level (fuel_level_date_time, vin, fuel_level, modified_date_time) VALUES ('2017-03-01 00:00:00','1FAGB45ARHA387092','0.8', '2017-01-01 00:00:00');
INSERT INTO integration.fuel_level (fuel_level_date_time, vin, fuel_level, modified_date_time) VALUES ('2017-03-04 00:00:00','1FAGB45ARHA387092','0.7', '2017-01-01 00:00:00');
INSERT INTO integration.fuel_level (fuel_level_date_time, vin, fuel_level, modified_date_time) VALUES ('2017-03-10 00:00:00','1FAGB45ARHA387092','0.6', '2017-01-01 00:00:00');
INSERT INTO integration.fuel_level (fuel_level_date_time, vin, fuel_level, modified_date_time) VALUES ('2017-04-08 00:00:00','1FAGB45ARHA387092','0.7', '2017-01-01 00:00:00');
INSERT INTO integration.fuel_level (fuel_level_date_time, vin, fuel_level, modified_date_time) VALUES ('2017-04-09 00:00:00','1FAGB45ARHA387092','0.5', '2017-01-01 00:00:00');
INSERT INTO integration.fuel_level (fuel_level_date_time, vin, fuel_level, modified_date_time) VALUES ('2017-04-10 00:00:00','1FAGB45ARHA387092','0.3', '2017-01-01 00:00:00');

INSERT INTO integration.fuel_level (fuel_level_date_time, vin, fuel_level, modified_date_time) VALUES ('2017-01-01 00:00:00','5HXXH23HXAM239085','0.8', '2017-01-01 00:00:00');
INSERT INTO integration.fuel_level (fuel_level_date_time, vin, fuel_level, modified_date_time) VALUES ('2017-01-10 00:00:00','5HXXH23HXAM239085','0.7', '2017-01-01 00:00:00');

INSERT INTO integration.fuel_level (fuel_level_date_time, vin, fuel_level, modified_date_time) VALUES ('2017-02-01 00:00:00','5HXXH23HXAM239085','0.6', '2017-01-01 00:00:00');
INSERT INTO integration.fuel_level (fuel_level_date_time, vin, fuel_level, modified_date_time) VALUES ('2017-02-10 00:00:00','5HXXH23HXAM239085','0.5', '2017-01-01 00:00:00');

INSERT INTO integration.fuel_level (fuel_level_date_time, vin, fuel_level, modified_date_time) VALUES ('2017-03-01 00:00:00','5HXXH23HXAM239085','0.8', '2017-01-01 00:00:00');
INSERT INTO integration.fuel_level (fuel_level_date_time, vin, fuel_level, modified_date_time) VALUES ('2017-03-10 00:00:00','5HXXH23HXAM239085','0.6', '2017-01-01 00:00:00');

INSERT INTO integration.fuel_level (fuel_level_date_time, vin, fuel_level, modified_date_time) VALUES ('2017-04-07 00:00:00','5HXXH23HXAM239085','0.8', '2017-01-01 00:00:00');
INSERT INTO integration.fuel_level (fuel_level_date_time, vin, fuel_level, modified_date_time) VALUES ('2017-04-08 00:00:00','5HXXH23HXAM239085','0.4', '2017-01-01 00:00:00');
INSERT INTO integration.fuel_level (fuel_level_date_time, vin, fuel_level, modified_date_time) VALUES ('2017-04-09 00:00:00','5HXXH23HXAM239085','0.8', '2017-01-01 00:00:00');
INSERT INTO integration.fuel_level (fuel_level_date_time, vin, fuel_level, modified_date_time) VALUES ('2017-04-10 00:00:00','5HXXH23HXAM239085','0.7', '2017-01-01 00:00:00');

INSERT INTO integration.fuel_level (fuel_level_date_time, vin, fuel_level, modified_date_time) VALUES ('2017-01-01 00:00:00','1HGBH41JXMN109186','0.7', '2017-01-01 00:00:00');
INSERT INTO integration.fuel_level (fuel_level_date_time, vin, fuel_level, modified_date_time) VALUES ('2017-01-09 00:00:00','1HGBH41JXMN109186','0.6', '2017-01-01 00:00:00');

INSERT INTO integration.fuel_level (fuel_level_date_time, vin, fuel_level, modified_date_time) VALUES ('2017-02-01 00:00:00','1HGBH41JXMN109186','0.8', '2017-01-01 00:00:00');
INSERT INTO integration.fuel_level (fuel_level_date_time, vin, fuel_level, modified_date_time) VALUES ('2017-02-28 00:00:00','1HGBH41JXMN109186','0.6', '2017-01-01 00:00:00');

INSERT INTO integration.fuel_level (fuel_level_date_time, vin, fuel_level, modified_date_time) VALUES ('2017-03-01 00:00:00','1HGBH41JXMN109186','0.7', '2017-01-01 00:00:00');
INSERT INTO integration.fuel_level (fuel_level_date_time, vin, fuel_level, modified_date_time) VALUES ('2017-03-11 00:00:00','1HGBH41JXMN109186','0.6', '2017-01-01 00:00:00');

INSERT INTO integration.fuel_level (fuel_level_date_time, vin, fuel_level, modified_date_time) VALUES ('2017-04-01 00:00:00','1HGBH41JXMN109186','0.5', '2017-01-01 00:00:00');
INSERT INTO integration.fuel_level (fuel_level_date_time, vin, fuel_level, modified_date_time) VALUES ('2017-04-21 00:00:00','1HGBH41JXMN109186','0.4', '2017-01-01 00:00:00');
INSERT INTO integration.fuel_level (fuel_level_date_time, vin, fuel_level, modified_date_time) VALUES ('2017-05-09 00:00:00','1HGBH41JXMN109186','0.8', '2017-01-01 00:00:00');
INSERT INTO integration.fuel_level (fuel_level_date_time, vin, fuel_level, modified_date_time) VALUES ('2017-05-10 00:00:00','1HGBH41JXMN109186','0.7', '2017-01-01 00:00:00');

-- INSERT TABLE integration.rental_vehicle

INSERT INTO integration.rental_vehicle (vin, vehicle_name, vehicle_type, modified_date_time) VALUES ('1HGBH41JXMN109186','porsche' ,'sports car', '2017-01-01 00:00:00');
INSERT INTO integration.rental_vehicle (vin, vehicle_name, vehicle_type, modified_date_time) VALUES ('5HXXH23HXAM239085','mazda miata' ,'sports car', '2017-01-01 00:00:00');
INSERT INTO integration.rental_vehicle (vin, vehicle_name, vehicle_type, modified_date_time) VALUES ('1FAGB45ARHA387092','minibus' ,'van', '2017-01-01 00:00:00');

-- INSERT TABLE staging.car
INSERT INTO  staging.car (vin, vehicle_name, modified_date_time) 
VALUES ('1HGBH41JXMN109186', 'porsche', '2017-01-01 00:00:00');
INSERT INTO  staging.car (vin, vehicle_name, modified_date_time) 
VALUES ('5HXXH23HXAM239085', 'mazda miata', '2017-01-01 00:00:00');

-- INSERT TABLE staging.van
INSERT INTO  staging.van (vin, vehicle_name, modified_date_time) 
VALUES ('1FAGB45ARHA387092', 'minibus', '2017-01-01 00:00:00');

-- INSERT TABLE staging.rental
INSERT INTO staging.rental SELECT * from integration.rental;

-- INSERT TABLE staging.fuel_level YYYY-MM-DD
INSERT INTO staging.fuel_level SELECT * from integration.fuel_level;

*/
-- *****************************************************************                                  
-- Create CSV files from STAGING TABLES and put them into Amazon S3
-- *****************************************************************
-- Create file format objects
use schema STAGING;
CREATE OR REPLACE FILE FORMAT my_csv_format 
                  TYPE = 'CSV';
/*
copy into 's3://edw-load/car_rental_system/staging_van.csv.gz'
  from staging.van
  credentials = (aws_key_id='AKIAXHA7RHLUNKXC4AJC' aws_secret_key='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')
  file_format = ( format_name = 'my_csv_format' )
  header=true
  SINGLE = TRUE;
  
copy into 's3://edw-load/car_rental_system/staging_car.csv.gz'
  from staging.car
  credentials = (aws_key_id='AKIAXHA7RHLUNKXC4AJC' aws_secret_key='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')
  file_format = ( format_name = 'my_csv_format' )
  header=true
  SINGLE = TRUE;

copy into 's3://edw-load/car_rental_system/staging_rental.csv.gz'
  from staging.rental
  credentials = (aws_key_id='AKIAXHA7RHLUNKXC4AJC' aws_secret_key='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')
  file_format = ( format_name = 'my_csv_format' )
  header=true
  SINGLE = TRUE;
  
copy into 's3://edw-load/iot_fuel_sensor/staging_fuel_level.csv.gz'
  from staging.fuel_level
  credentials = (aws_key_id='AKIAXHA7RHLUNKXC4AJC' aws_secret_key='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')
  file_format = ( format_name = 'my_csv_format' )
  header=true
  SINGLE = TRUE;
*/

-- *********************************************************************************************** 
-- ************************************** MERGE (UPDATE) INTEGRATION-- ***************************
-- *********************************************************************************************** 
merge into integration.rental t1 using staging.rental t2 on t1.vin = t2.vin
    when matched and t1.open_rental_ind = t2.open_rental_ind and t1.penalty_rental_charge = t2.penalty_rental_charge
    then update set t1.drop_off_date_time = t2.drop_off_date_time,
                    t1.penalty_rental_charge = t2.penalty_rental_charge,
                    t1.actual_rental_charge = t2.actual_rental_charge,
                    t1.modified_date_time = CURRENT_TIMESTAMP
    when not matched then insert (t1.open_rental_ind,
                                  t1.drop_off_date_time,
                                  t1.penalty_rental_charge,
                                  t1.actual_rental_charge,
                                  t1.modified_date_time) 
                          values (t2.open_rental_ind,
                                  t2.drop_off_date_time,
                                  t2.penalty_rental_charge,
                                  t2.actual_rental_charge,
                                  CURRENT_TIMESTAMP);

merge into integration.fuel_level t1 using staging.fuel_level t2 on t1.vin = t2.vin
    when matched and t1.fuel_level_date_time = t2.fuel_level_date_time 
    then update set t1.fuel_level = t2.fuel_level,
                    t1.modified_date_time = CURRENT_TIMESTAMP
    when not matched then insert (t1.fuel_level_date_time,
                                  t1.vin,
                                  t1.fuel_level,
                                  t1.modified_date_time) 
                          values (t2.fuel_level_date_time,
                                  t2.vin,
                                  t2.fuel_level,
                                  CURRENT_TIMESTAMP);                        

merge into integration.rental_vehicle t1 using
    (
      SELECT vin, vehicle_name, 'car' vehicle_type, modified_date_time FROM STAGING.CAR
      UNION ALL
      SELECT vin, vehicle_name, 'van' vehicle_type, modified_date_time FROM STAGING.VAN
    ) t2
    on t1.vin = t2.vin
    when matched and t1.vehicle_name = t2.vehicle_name  
    then update set t1.modified_date_time = CURRENT_TIMESTAMP
    when not matched then insert (t1.vin,
                                  t1.vehicle_name,
                                  t1.modified_date_time) 
                          values (t2.vin,
                                  t2.vehicle_name,
                                  CURRENT_TIMESTAMP);
                                    
-- *****************************************************************                                  
-- ******************** CREATE EXTERNAL TABLES *********************
-- *****************************************************************
-- *****************************************************************                                  
-- Create external tables
-- *****************************************************************
/*
list @MYS3STAGEfuel_level;
list @MYS3STAGEvan;
list @MYS3STAGEcar;
list @MYS3STAGErental;

remove @MYS3STAGEfuel_level pattern='.*.';
remove @MYS3STAGEvan pattern='.*.';
remove @MYS3STAGEcar pattern='.*.';
remove @MYS3STAGErental pattern='.*.';
drop table S3CAR;
drop table S3FUEL_LEVEL;
drop table S3VAN;  
drop table S3RENTAL;
*/

-- Create a named stage object
create or replace stage MYS3STAGEfuel_level url='s3://edw-load/iot_fuel_sensor/staging_fuel_level' 
                        CREDENTIALS=(aws_key_id='AKIAXHA7RHLUNKXC4AJC' 
                                     aws_secret_key='SvuaJCmvywSq7whPh6hD2JFRP8GH7b+csLoCELPX') 
                        file_format = my_csv_format;
                      
create or replace stage MYS3STAGEvan url='s3://edw-load/car_rental_system/staging_van' 
                        CREDENTIALS=(aws_key_id='AKIAXHA7RHLUNKXC4AJC' 
                                     aws_secret_key='SvuaJCmvywSq7whPh6hD2JFRP8GH7b+csLoCELPX') 
                        file_format = my_csv_format;
                        
create or replace stage MYS3STAGEcar url='s3://edw-load/car_rental_system/staging_car' 
                        CREDENTIALS=(aws_key_id='AKIAXHA7RHLUNKXC4AJC' 
                                     aws_secret_key='SvuaJCmvywSq7whPh6hD2JFRP8GH7b+csLoCELPX') 
                        file_format = my_csv_format; 
                        
create or replace stage MYS3STAGErental url='s3://edw-load/car_rental_system/staging_rental' 
                        CREDENTIALS=(aws_key_id='AKIAXHA7RHLUNKXC4AJC' 
                                     aws_secret_key='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') 
                        file_format = my_csv_format;  
                        
-- CREATE AN EXTERNAL TABLE
copy into @MYS3STAGEfuel_level/staging_fuel_level from staging.fuel_level single = true;
copy into @MYS3STAGEvan/staging_van from staging.van single = true;
copy into @MYS3STAGEcar/staging_car from staging.car single = true;
copy into @MYS3STAGErental/staging_rental from staging.rental single = true;
                        
-- CREATE AN EXTERNAL TABLE
create or replace external table S3fuel_level
(
  vin varchar as (value:c2::varchar), 
  fuel_level number as (value:c3::number),
  fuel_level_date_time timestamp as (value:c1::timestamp),
  modified_date_time timestamp as (value:c4::timestamp)
)
location = @MYS3STAGEfuel_level file_format = my_csv_format;

create or replace external table S3van
(
  vin varchar as (value:c1::varchar), 
  vehicle_name varchar as (value:c2::varchar),
  modified_date_time timestamp as (value:c3::timestamp)
)
with location = @MYS3STAGEvan file_format = my_csv_format;

create or replace external table S3car
(
  vin varchar as (value:c1::varchar), 
  vehicle_name varchar as (value:c2::varchar),
  modified_date_time timestamp as (value:c3::timestamp)
)
with location = @MYS3STAGEcar file_format = my_csv_format;

create or replace external table S3rental
(
 pick_up_date_time timestamp as (value:c1::timestamp),
 vin varchar as (value:c2::varchar),
 open_rental_ind varchar as (value:c3::varchar),
 drop_off_date_time timestamp as (value:c4::timestamp),
 penalty_rental_charge number as (value:c5::number),
 actual_rental_charge number as (value:c6::number),
 modified_date_time timestamp as (value:c7::timestamp)
)
with location = @MYS3STAGErental file_format = my_csv_format;

-- TRUNCATE staging tables before loading from S3
TRUNCATE TABLE STAGING.CAR;
TRUNCATE TABLE STAGING.FUEL_LEVEL;
TRUNCATE TABLE STAGING.RENTAL;
TRUNCATE TABLE STAGING.VAN;

INSERT INTO staging.fuel_level ( vin, fuel_level, fuel_level_date_time, modified_date_time ) SELECT vin, fuel_level, fuel_level_date_time, current_timestamp FROM staging.S3fuel_level;
INSERT INTO staging.van ( vin, vehicle_name, modified_date_time ) SELECT vin, vehicle_name, current_timestamp FROM staging.S3van;
INSERT INTO staging.car ( vin, vehicle_name, modified_date_time ) SELECT vin, vehicle_name, current_timestamp FROM staging.S3car;
INSERT INTO staging.rental (pick_up_date_time,
                         vin, open_rental_ind,
                         drop_off_date_time,
                         penalty_rental_charge,
                         actual_rental_charge,
                         modified_date_time) SELECT pick_up_date_time,
                         vin, open_rental_ind,
                         drop_off_date_time,
                         penalty_rental_charge,
                         actual_rental_charge,
                         current_timestamp FROM staging.S3rental;